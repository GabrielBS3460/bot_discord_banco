datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Usuarios {
  discord_id     String  @id
  nivel_narrador Int     @default(1)
  
  personagens Personagens[]
  
  personagemAtivo   Personagens? @relation("PersonagemAtivo", fields: [personagem_ativo_id], references: [id])
  personagem_ativo_id Int?         @unique 
}

model Personagens {
  id        Int      @id @default(autoincrement())
  nome      String   @unique
  saldo     Float    @default(0)

  ultimo_resgate_recompensa DateTime?
  ultimo_resgate_manavitra  DateTime?
  
  nivel_personagem Int @default(3) 
  pontos_missao    Int @default(0) 
  
  vida_atual    Int     @default(10)
  vida_max      Int     @default(10)
  vida_temp     Int     @default(0)
  mana_atual    Int     @default(0)
  mana_max      Int     @default(0)
  mana_temp     Int     @default(0)
  
  pontos_forja_atual   Float     @default(0)
  pontos_forja_diarios Int       @default(1)
  ultimo_resgate_forja DateTime?
  ultimo_descanso      DateTime?

  estoque_ingredientes  Json     @default("{}") 
  receitas_conhecidas   String[] @default([])   
  
  feira_itens           Json     @default("[]")
  feira_data_geracao    DateTime?               
  
  deslocamento  String  @default("9m")
  observacoes   String?
  banner_url    String?

  forca         Int     @default(0)
  destreza      Int     @default(0)
  constituicao  Int     @default(0)
  inteligencia  Int     @default(0)
  sabedoria     Int     @default(0)
  carisma       Int     @default(0)
  
  jogador    Usuarios @relation(fields: [usuario_id], references: [discord_id])
  usuario_id String   

  apostasBicho     ApostasBicho[]

  transacoes Transacao[]
  classes    PersonagemClasse[]
  utilizadorAtivo Usuarios? @relation("PersonagemAtivo")
  
  inscricoes Inscricoes[]

  pericias      String[] @default([])
}

model PersonagemClasse {
  id            Int         @id @default(autoincrement())
  nome_classe   String
  nivel         Int
  
  personagem    Personagens @relation(fields: [personagem_id], references: [id], onDelete: Cascade)
  personagem_id Int

  @@unique([personagem_id, nome_classe]) 
}

model Transacao {
  id        Int      @id @default(autoincrement())
  data      DateTime @default(now())
  descricao String
  valor     Float
  tipo      String
  categoria String?

  personagem    Personagens @relation(fields: [personagem_id], references: [id], onUpdate: Cascade)
  personagem_id Int
}

model Missoes {
  id          String   @id @default(uuid()) 
  nome        String   @unique
  nd          Int
  vagas       Int
  status      String   @default("ABERTA") 
  criador_id  String   
  inscricoes  Inscricoes[]
}

model Inscricoes {
  id            Int      @id @default(autoincrement())
  missao        Missoes  @relation(fields: [missao_id], references: [id], onDelete: Cascade)
  missao_id     String
  personagem    Personagens @relation(fields: [personagem_id], references: [id], onDelete: Cascade)
  personagem_id Int
  selecionado   Boolean  @default(false)

  recompensa_resgatada Boolean  @default(false)

  @@unique([missao_id, personagem_id]) 
}

model ApostasBicho {
  id            String      @id @default(uuid())
  personagem    Personagens @relation(fields: [personagem_id], references: [id], onDelete: Cascade)
  personagem_id Int
  
  tipo          String   
  numero        String   
  posicao       String   
  valor         Float
  status        String   @default("PENDENTE") // PENDENTE, GANHOU, PERDEU
  data          DateTime @default(now())
}

model SorteiosBicho {
  id          Int      @id @default(autoincrement())
  data        DateTime @default(now())
  resultados  String[] 
}

model Avaliacao {
  id              Int      @id @default(autoincrement())
  mestre_id       String
  avaliador_id    String
  link_missao     String
  nota_ritmo      Int
  nota_imersao    Int
  nota_preparo    Int
  nota_conhecimento Int
  nota_geral      Int
  data_avaliacao  DateTime @default(now())
}